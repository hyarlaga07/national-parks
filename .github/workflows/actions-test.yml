name: Actions testing

env: 
  QUAY_USERNAME: ${{ secrets.QUAY_USERNAME }}
  QUAY_PASSWORD: ${{ secrets.QUAY_PASSWORD }}
  REDHAT_USERNAME: ${{ secrets.REDHAT_USERNAME }}
  REDHAT_PASSWORD: ${{ secrets.REDHAT_PASSWORD }}
  GIT_USERNAME: ${{ secrets.GIT_USERNAME }}
  GIT_EMAIL: ${{ secrets.GIT_EMAIL }}
  Z_IMAGE_TAGS: s390x-${{ github.sha }}
  X_IMAGE_TAGS: amd64-${{ github.sha }}
  MANIFEST_IMAGE_TAG: manifest-${{ github.sha }}
  ROX_CENTRAL_ADDRESS: ${{ secrets.ROX_ADDRESS }}
  ROX_API_TOKEN: ${{ secrets.ROX_API_TOKEN }}

  IMAGE_REGISTRY: quay.io/mmondics
  APP_NAME: nationalparks
  MANIFEST_NAME: nationalparks-manifest
  
on: push

jobs:

  acs-image-scan: 
    name: Scan container manifest with Red Hat Advanced Cluster Security
    runs-on: [self-hosted, linux, x64]
    environment: openshift
    continue-on-error: true
    
    steps:
    - name: install roxctl cli        
      run: | 
        curl -O https://mirror.openshift.com/pub/rhacs/assets/4.1.0/bin/Linux/roxctl
        chmod +x roxctl
    - name: deployment-check
      run: |
        ./roxctl --insecure-skip-tls-verify deployment check --endpoint ${{ env.ROX_CENTRAL_ADDRESS }} -f yaml/combined/national-parks-combined.yaml 2>&1 | tee deployment_check.txt
    - name: image-scan
      run: |
        ./roxctl --insecure-skip-tls-verify image scan --endpoint ${{ env.ROX_CENTRAL_ADDRESS }} --image quay.io/centos7/httpd-24-centos7:centos7 2>&1 | tee image_scan.json
    - name: image-check
      run: |
        ./roxctl --insecure-skip-tls-verify image check --endpoint ${{ env.ROX_CENTRAL_ADDRESS }} --image quay.io/centos7/httpd-24-centos7:centos7 2>&1 | tee image_check.txt
